<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDS | Stratejik Envanter YÃ¶netimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; color: #0f172a; font-family: 'Inter', sans-serif; }
        .brand-red { background-color: #be123c; } 
        .sidebar-active { background-color: rgba(190, 18, 60, 0.1); border-right: 3px solid #be123c; color: #be123c !important; font-weight: 700; }
        .stat-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1); }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #be123c; cursor: pointer; margin-top: -6px; box-shadow: 0 0 0 3px rgba(190, 18, 60, 0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-[#1e293b] flex flex-col flex-shrink-0 shadow-2xl z-50">
        <div class="p-6 border-b border-slate-700 bg-[#0f172a]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 brand-red rounded flex items-center justify-center text-white"><i class="fa-solid fa-cat"></i></div>
                <h1 class="text-white font-bold text-lg tracking-tight">KIRMIZI KEDÄ°</h1>
            </div>
        </div>
        <nav class="flex-1 mt-6 px-4 space-y-2 overflow-y-auto text-sm">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 mt-4">Analiz ModÃ¼lleri</p>
            <a href="subeler.html" class="flex items-center gap-3 px-3 py-3 rounded text-slate-400 hover:text-white hover:bg-slate-700 transition"><i class="fa-solid fa-store w-5 text-center"></i> Åubelerim</a>
            <a href="lokasyon.html" class="flex items-center gap-3 px-3 py-3 rounded text-slate-400 hover:text-white hover:bg-slate-700 transition"><i class="fa-solid fa-map-location-dot w-5 text-center"></i> Lokasyon Analizi</a>
            <a href="talep.html" class="flex items-center gap-3 px-3 py-3 rounded text-slate-400 hover:text-white hover:bg-slate-700 transition"><i class="fa-solid fa-chart-line w-5 text-center"></i> Talep Analizi</a>
            <a href="pazarlama.html" class="flex items-center gap-3 px-3 py-3 rounded text-slate-400 hover:text-white hover:bg-slate-700 transition"><i class="fa-solid fa-chart-line w-5 text-center"></i> Pazarlama Stratejisi</a>
            <a href="envanter.html" class="flex items-center gap-3 px-3 py-3 rounded sidebar-active"><i class="fa-solid fa-boxes-stacked w-5 text-center"></i> Envanter YÃ¶netimi</a>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-8 bg-slate-50">
        
        <header class="flex justify-between items-end mb-6 border-b border-slate-200 pb-4">
            <div>
                <h2 class="text-2xl font-extrabold text-slate-800">Envanter Karar Destek Kokpiti</h2>
                <p class="text-sm text-slate-500 mt-1">Stok optimizasyonu, Trigger alarmlarÄ± ve What-If analizi.</p>
            </div>
            
            <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm w-64">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Pazar Senaryosu</span>
                    <span id="scenarioValue" class="text-xs font-bold text-blue-600">%0 (Normal)</span>
                </div>
                <input type="range" id="whatIfSlider" min="-50" max="50" step="10" value="0"
                oninput="updateScenario(this.value)">
                
                <p class="text-[8px] text-slate-400 mt-1 text-center">Talep ArtÄ±ÅŸ/AzalÄ±ÅŸ SimÃ¼lasyonu</p>
            </div>
        </header>

        <div class="stat-card p-5 mb-8 border-t-4 border-emerald-500">
            <h3 class="text-xs font-bold text-slate-600 uppercase mb-3"><i class="fa-solid fa-database mr-2"></i>HÄ±zlÄ± Stok GiriÅŸi (VeritabanÄ±: sube_stoklari)</h3>
            <form id="addForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <input type="number" id="add_sube_id" placeholder="Åube ID" required class="border p-2 rounded text-xs outline-none focus:border-emerald-500">
                <input type="number" id="add_tur_id" placeholder="TÃ¼r ID" required class="border p-2 rounded text-xs outline-none focus:border-emerald-500">
                <input type="number" id="add_stok" placeholder="Mevcut Stok" required class="border p-2 rounded text-xs outline-none focus:border-emerald-500">
                <input type="number" id="add_esik" placeholder="Kritik EÅŸik" required class="border p-2 rounded text-xs outline-none focus:border-emerald-500">
                <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded text-xs transition shadow-sm">KAYDET</button>
            </form>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card p-5 border-l-4 border-l-emerald-500">
                <span class="text-[10px] font-bold text-slate-400 uppercase">Mevcut Envanter DeÄŸeri</span>
                <div class="text-2xl font-black text-slate-800 mt-1" id="kpi-total-value">...</div>
            </div>
            <div class="stat-card p-5 border-l-4 border-l-blue-500">
                <span class="text-[10px] font-bold text-slate-400 uppercase">6 AylÄ±k BÃ¼tÃ§e Ä°htiyacÄ±</span>
                <div class="text-2xl font-black text-blue-600 mt-1" id="kpi-budget-need">...</div>
                <p class="text-[10px] text-slate-400 mt-1">Senaryoya gÃ¶re deÄŸiÅŸir</p>
            </div>
            <div class="stat-card p-5 border-l-4 border-l-orange-500">
                <span class="text-[10px] font-bold text-slate-400 uppercase">Stratejik ÃœrÃ¼nler</span>
                <div class="text-2xl font-black text-orange-500 mt-1" id="kpi-strategic-count">...</div>
                <p class="text-[10px] text-orange-400 mt-1">Planlama gerektiren</p>
            </div>
            <div class="stat-card p-5 border-l-4 border-l-purple-500">
                <span class="text-[10px] font-bold text-slate-400 uppercase">Alarm (Trigger)</span>
                <div class="text-2xl font-black text-purple-600 mt-1" id="kpi-trigger-status">Aktif</div>
                <p class="text-[10px] text-purple-400 mt-1">MySQL Stok KontrolÃ¼</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="stat-card p-5">
                <h4 class="text-xs font-bold text-slate-600 uppercase mb-4">ğŸ“¦ ABC Analizi (Senaryolu)</h4>
                <div class="h-40"><canvas id="chartABC"></canvas></div>
            </div>
            <div class="stat-card p-5">
                <h4 class="text-xs font-bold text-slate-600 uppercase mb-4">â³ Raf Ã–mrÃ¼ Riskleri</h4>
                <div class="h-40"><canvas id="chartShelfLife"></canvas></div>
            </div>
            <div class="stat-card p-5">
                <h4 class="text-xs font-bold text-slate-600 uppercase mb-4">ğŸ“š Kategori DaÄŸÄ±lÄ±mÄ±</h4>
                <div class="h-40"><canvas id="chartCategories"></canvas></div>
            </div>
        </div>

        <div class="stat-card p-6">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-robot text-brand-red"></i> Yapay Zeka Aksiyon PlanÄ± (6-12 Ay)
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                        <tr>
                            <th class="px-4 py-3">Stok ID / Kategori</th>
                            <th class="px-4 py-3">Mevcut VarlÄ±k</th>
                            <th class="px-4 py-3">Gelecek Tahmini (SimÃ¼lasyon)</th>
                            <th class="px-4 py-3">Strateji</th>
                            <th class="px-4 py-3 text-right">KDS KararÄ± / Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                        <tr><td colspan="5" class="text-center py-4 text-slate-400">Veri yÃ¼kleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        var globalABCChart;
        var globalRiskChart;
        var globalCategoryChart;
        let globalData = []; 

        document.addEventListener("DOMContentLoaded", function() {
            refreshInventory();

            const slider = document.getElementById('whatIfSlider');
            if(slider) {
                slider.addEventListener('input', function() {
                    const val = parseInt(this.value);
                    const label = document.getElementById('scenarioValue');
                    label.innerText = `%${val} (${val === 0 ? 'Normal' : (val > 0 ? 'ArtÄ±ÅŸ' : 'DÃ¼ÅŸÃ¼ÅŸ')})`;
                    label.className = `text-xs font-bold ${val === 0 ? 'text-blue-600' : (val > 0 ? 'text-green-600' : 'text-red-600')}`;
                    
                    calistirKDS(globalData, val);
                });
            }
        });

        // --- VERÄ° Ã‡EKME FONKSÄ°YONU ---
        async function refreshInventory() {
            fetch('/api/envanter')
                .then(res => res.json())
                .then(data => {
                    globalData = data; 
                    calistirKDS(data, 0); 
                })
                .catch(err => {
                    console.error("Hata:", err);
                    document.getElementById('inventory-table-body').innerHTML = 
                        `<tr><td colspan="5" class="text-center text-red-500 py-4 font-bold">Veri Ã§ekilemedi.</td></tr>`;
                });
        }

        // --- CRUD: EKLEME Ä°ÅLEMÄ° (VeritabanÄ± Uyumlu) ---
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                sube_id: document.getElementById('add_sube_id').value,
                tur_id: document.getElementById('add_tur_id').value,
                mevcut_stok: document.getElementById('add_stok').value,
                kritik_esik: document.getElementById('add_esik').value
            };
            const res = await fetch('/api/envanter-ekle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                document.getElementById('addForm').reset();
                refreshInventory(); // Listeyi yenile
            }
        });

        // --- CRUD: SÄ°LME Ä°ÅLEMÄ° ---
        async function deleteProduct(id) {
            if(!confirm(`#${id} nolu kaydÄ± silmek istiyor musunuz?`)) return;
            const res = await fetch(`/api/envanter-sil/${id}`, { method: 'DELETE' });
            if(res.ok) refreshInventory(); // Listeyi yenile
        }

        // --- SENÄ°N ORÄ°JÄ°NAL KDS MANTIÄIN (VERÄ°TABANI EÅLEÅTÄ°RÄ°LMÄ°Å) ---
        function calistirKDS(dbData, degisimYuzdesi) {
            const tableBody = document.getElementById('inventory-table-body');
            tableBody.innerHTML = "";
            let toplamStokDegeri = 0;
            let butceIhtiyaci = 0;
            let stratejikUrun = 0;
            let kategoriVerisi = {};
            
            const carpan = 1 + (degisimYuzdesi / 100); 

            if(!dbData || dbData.length === 0) { 
                tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center">Veri yok.</td></tr>`; 
                return; 
            }

            dbData.forEach(kitap => {
                // Åemana gÃ¶re veri eÅŸleme (BurayÄ± dÃ¼zelttim!)
                // EÄŸer veritabanÄ±nda 'stok' diye gelirse onu alÄ±r, yoksa 'mevcut_stok' alÄ±r.
                const stok = parseInt(kitap.mevcut_stok || kitap.stok || 0);
                const esik = parseInt(kitap.kritik_esik || 0);
                // ID eÅŸleme
                const stokId = kitap.stok_id || kitap.id;
                
                const maliyet = 50; // Åemada maliyet yoksa varsayÄ±lan
                const bazSatisHizi = 0.5; // SimÃ¼lasyon hÄ±zÄ±
                const kategori = kitap.tur_id ? `TÃ¼r ${kitap.tur_id}` : "Genel";

                const simuleSatisHizi = bazSatisHizi * carpan;
                toplamStokDegeri += (stok * maliyet);

                let altiAylikTalep = Math.ceil(simuleSatisHizi * 180); // Basit projeksiyon
                let stokFarki = stok - altiAylikTalep;

                let projeksiyonHTML, stratejiBadge, kararBtn, rowClass = "hover:bg-slate-50 border-b";

                // MantÄ±k: Stok Kritik EÅŸiÄŸin AltÄ±ndaysa veya Talep KarÅŸÄ±lamÄ±yorsa
                if (stok <= esik || stokFarki < 0) {
                    let acik = Math.abs(stokFarki);
                    let maliyetTahmini = acik * maliyet;
                    butceIhtiyaci += maliyetTahmini;
                    stratejikUrun++;

                    rowClass = "bg-orange-50/50 border-b border-orange-100";
                    projeksiyonHTML = `
                        <div class="text-xs font-bold text-slate-600">Hedef: ${altiAylikTalep}</div>
                        <div class="text-[9px] text-red-500 font-bold">Kritik!</div>
                    `;
                    stratejiBadge = `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase">BÃ¼yÃ¼me</span>`;
                    kararBtn = `<button class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold shadow-sm">Tedarik</button>`;
                }
                else {
                    projeksiyonHTML = `
                        <div class="text-xs font-bold text-emerald-600">Dengeli</div>
                        <div class="text-[9px] text-slate-400">Yeterli</div>
                    `;
                    stratejiBadge = `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Ä°zle</span>`;
                    kararBtn = `<span class="text-slate-400 text-[10px]">-</span>`;
                }

                tableBody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3">
                            <div class="font-bold text-slate-800">#${stokId}</div>
                            <div class="text-[10px] text-slate-500">${kategori} (Åube: ${kitap.sube_id})</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="font-bold text-slate-700">${stok} Adet</div>
                            <div class="text-[9px] text-slate-400">EÅŸik: ${esik}</div>
                        </td>
                        <td class="px-4 py-3">${projeksiyonHTML}</td>
                        <td class="px-4 py-3">${stratejiBadge}</td>
                        <td class="px-4 py-3 text-right">
                             <div class="flex items-center justify-end gap-2">
                                ${kararBtn}
                                <button onclick="deleteProduct(${stokId})" class="text-red-400 hover:text-red-600 p-2"><i class="fa-solid fa-trash-can"></i></button>
                             </div>
                        </td>
                    </tr>
                `;

                if(!kategoriVerisi[kategori]) kategoriVerisi[kategori] = 0;
                kategoriVerisi[kategori] += stok;
            });

            // KPI GÃ¼ncelleme
            document.getElementById('kpi-total-value').innerText = "â‚º" + nFmt(toplamStokDegeri);
            document.getElementById('kpi-budget-need').innerText = "â‚º" + nFmt(butceIhtiyaci);
            document.getElementById('kpi-strategic-count').innerText = stratejikUrun;

            cizGrafikler(kategoriVerisi, degisimYuzdesi);
        }

        function nFmt(num) {
            return new Intl.NumberFormat('tr-TR', { maximumSignificantDigits: 3 }).format(num);
        }

        function cizGrafikler(kategoriVerisi, yuzde) {
            const labels = Object.keys(kategoriVerisi);
            const data = Object.values(kategoriVerisi);
            const ctxOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

            // ABC GrafiÄŸi
            if(window.globalABCChart) window.globalABCChart.destroy();
            window.globalABCChart = new Chart(document.getElementById('chartABC'), { 
                type: 'doughnut', 
                data: { labels: ['A', 'B', 'C'], datasets: [{ data: [65+yuzde/2, 25, 10-yuzde/2], backgroundColor: ['#ea580c', '#3b82f6', '#94a3b8'], borderWidth: 0 }] }, 
                options: { ...ctxOpts, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } } } 
            });
            
            // Raf Ã–mrÃ¼ GrafiÄŸi
            if(window.globalRiskChart) window.globalRiskChart.destroy();
            window.globalRiskChart = new Chart(document.getElementById('chartShelfLife'), { type: 'bar', data: { labels: ['R1','R2','R3','R4'], datasets: [{ data: [15+yuzde, 120, 200-yuzde, 30], backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { ...ctxOpts, scales: { x: { grid: {display:false} }, y: { display:false } } } });

            // Kategori GrafiÄŸi
            if(window.globalCategoryChart) window.globalCategoryChart.destroy();
            window.globalCategoryChart = new Chart(document.getElementById('chartCategories'), { 
                type: 'doughnut', 
                data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#f43f5e', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'], borderWidth: 0 }] }, 
                options: { ...ctxOpts, cutout: '65%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } } } 
            });
        }

        function updateScenario(val) {
            const yuzde = parseInt(val); 
            const label = document.getElementById('scenarioValue');
            if (label) {
                label.innerText = `%${yuzde} (${yuzde > 0 ? 'BÃ¼yÃ¼me' : yuzde < 0 ? 'Daralma' : 'Stabil'})`;
                label.style.color = yuzde > 0 ? "#059669" : (yuzde < 0 ? "#be123c" : "#374151");
            }
            calistirKDS(globalData, yuzde);
        }
    </script>
</body>
</html>