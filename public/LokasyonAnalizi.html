<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDS | Lokasyon Analizi (MCDA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        
        body { background-color: #f1f5f9; color: #0f172a; font-family: 'Inter', sans-serif; overflow: hidden; }
        .brand-red { background-color: #be123c; } 
        
        .sidebar-link { color: #94a3b8; transition: all 0.2s; }
        .sidebar-link:hover { color: white; background-color: rgba(255,255,255,0.05); }
        .sidebar-active { 
            color: #be123c !important; 
            font-weight: 700; 
            background-color: rgba(190, 18, 60, 0.1); 
            border-right: 3px solid #be123c; 
        }

        .stat-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        
        #map {
            flex:1;
            height: 100% !important;
            min-height: 100vh;
            width: 100%;
            background-color: #f1f5f9; 
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #be123c; cursor: pointer; margin-top: -6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }

        .leaflet-popup-content-wrapper { background: white; color: #0f172a; border-radius: 6px; font-family: 'Inter', sans-serif; }
        #map {
            height: 100% !important;
            flex: 1; 
        }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-[450px] bg-[#1e293b] flex flex-col flex-shrink-0 shadow-2xl z-50">
        <div class="p-6 border-b border-slate-700 bg-[#0f172a]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 brand-red rounded flex items-center justify-center text-white"><i class="fa-solid fa-chart-pie"></i></div>
                <h1 class="text-white font-bold text-lg tracking-tight">Kırmızı Kedi Kitabevi KDS</h1>
            </div>
        </div>
        <nav class="flex-1 mt-6 px-4 space-y-1 overflow-y-auto">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 mt-2 italic">Mevcut Varlıklar</p>
            <a href="subeler.html" class="flex items-center gap-3 px-3 py-3 text-sm rounded sidebar-link"><i class="fa-solid fa-store w-5 text-center"></i> Şubelerim</a>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 mt-6 italic">Büyüme Analizi</p>
            <a href="lokasyon.html" class="flex items-center gap-3 px-3 py-3 text-sm rounded sidebar-link sidebar-active"><i class="fa-solid fa-location-crosshairs w-5 text-center"></i> Lokasyon Analizi</a>
            <a href="talep.html" class="flex items-center gap-3 px-3 py-3 text-sm rounded sidebar-link"><i class="fa-solid fa-arrow-trend-up w-5 text-center"></i> Talep Analizi</a>
            <a href="pazarlama.html" class="flex items-center gap-3 px-3 py-3 text-sm rounded sidebar-link"><i class="fa-solid fa-bullseye w-5 text-center"></i> Pazarlama Stratejisi</a>
            <a href="envanter.html" class="flex items-center gap-3 px-3 py-3 text-sm rounded sidebar-link"><i class="fa-solid fa-warehouse w-5 text-center"></i> Envanter Yönetimi</a>
            
        <div class="p-4 bg-[#0f172a] border-t border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-white text-xs font-bold">YO</div>
                <div><p class="text-xs text-white font-bold">Yönetici Oturumu</p><p class="text-[10px] text-slate-400">Veritabanı: Online</p></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-10 bg-[#f8fafc]">
        
        <header class="mb-8 border-b border-slate-200 pb-6 flex justify-between items-end">
            <div>
                <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">MCDA Lokasyon Karar Destek</h2>
                <p class="text-slate-500 mt-1 text-sm">Çok Kriterli Karar Verme (AHP/MCDA) Yöntemi ile Yeni Şube Yeri Tespiti.</p>
            </div>
            <span class="px-3 py-1 bg-white border text-xs font-bold text-slate-500 rounded shadow-sm">Tablo: <span class="font-mono text-brand-red">kirmizi_kedi_kds.iller</span></span>
        </header>

<body class="bg-slate-50 h-screen flex flex-col overflow-hidden">

    <div class="flex flex-1 overflow-hidden"> <div class="w-1/3 min-w-[300px] p-6 bg-white border-r shadow-sm flex flex-col gap-6 overflow-y-auto z-10">
            <h2 class="text-xl font-black text-slate-800 border-b pb-2 uppercase tracking-tight">Lokasyon Analizi</h2>

            <div id="city-info-card" class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">İncelenen Bölge</p>
                <h3 id="selected-city-title" class="text-lg font-bold text-slate-700">İl Seçiniz...</h3>
                

                
                <div class="mt-4 p-3 bg-white rounded-lg border text-center shadow-sm">
                    <p class="text-[10px] text-slate-500 uppercase">Yatırım Skoru</p>
                    <div id="calculation-score-value" class="text-4xl font-black text-indigo-600">--</div>
                    <div id="calculation-status-text" class="text-[10px] font-bold mt-1 uppercase italic">Analiz Bekleniyor</div>
                </div>
            </div>

            <div class="flex-1 min-h-[300px] flex flex-col items-center">
                <p class="text-[10px] text-slate-400 font-bold uppercase mb-4 text-center border-b pb-1 w-full">Veri Kriter Dağılımı</p>
                <div class="w-full px-4 mb-2 flex flex-col items-center bg-slate-50 p-2 rounded border border-slate-200">
    <label for="scenarioSlider" class="text-[10px] font-bold text-slate-600 mb-1 flex justify-between w-full">
        <span>Senaryo Analizi (Nüfus & Gelir)</span>
        <span id="scenarioValue" class="text-blue-600">%0 Değişim</span>
    </label>
    <input type="range" id="scenarioSlider" min="-20" max="50" value="0" step="5" 
           class="w-full h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-blue-600">
    <p class="text-[8px] text-slate-400 mt-1">Gelecek projeksiyonu için kaydırın</p>
</div>
                <div class="grid grid-cols-2 gap-2 mt-4" style="height: 320px;">
    <div style="position: relative; height: 150px; width: 100%;">
        <canvas id="radarChart"></canvas>
    </div>
    <div style="position: relative; height: 150px; width: 100%;">
        <canvas id="barChart"></canvas>
    </div>
    <div style="position: relative; height: 150px; width: 100%;">
        <canvas id="doughnutChart"></canvas>
    </div>
    <div style="position: relative; height: 150px; width: 100%;">
        <canvas id="polarChart"></canvas>
    </div>
</div> 
            </div>
            

<div id="kds-advice-box" class="mt-4 p-4 rounded-lg border-l-8 border-gray-300 bg-gray-50 shadow-md transition-all duration-500">
    <h4 class="text-xs font-bold text-gray-500 tracking-widest uppercase mb-1">Yapay Zeka Yatırım Önerisi</h4>
    <p id="kds-advice-text" class="text-xl font-extrabold text-gray-700">
        Analiz bekleniyor...
    </p>
</div>
        </div>

        <div id="map" class="flex-1 h-full relative"></div>

    </div> </body>

        <div class="stat-card p-8">
            <div class="flex items-center gap-3 mb-6 border-b pb-4">
                <div class="w-10 h-10 rounded bg-slate-100 flex items-center justify-center text-slate-600"><i class="fa-solid fa-brain text-xl"></i></div>
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Veriye Dayalı Karar & Karlılık Skoru</h3>
                    <p class="text-xs text-slate-500">`karlilik_skorlari` tablosuna dayalı tahmini projeksiyon.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <h4 class="font-bold text-slate-900 uppercase text-xs flex items-center gap-2"><i class="fa-solid fa-list-check text-slate-400"></i> Silolojik Karar Motoru</h4>
                    <div class="p-4 bg-slate-50 rounded border-l-4 border-brand-red"><p class="font-mono text-xs mb-1 text-slate-400">ÖNERME 1 (Kural):</p><p class="font-bold text-sm italic text-slate-700">"Düşük <span class="text-brand-red">rakip_sayisi</span> ve yüksek <span class="text-brand-red">ogrenci_sayisi</span>, karlılık skorunu artırır."</p></div>
                    <div class="p-4 bg-slate-50 rounded border-l-4 border-slate-300"><p class="font-mono text-xs mb-1 text-slate-400">ÖNERME 2 (Bulgu):</p><p class="font-bold text-sm italic text-slate-700">"<span id="logic-city" class="text-brand-red">...</span> ili, mevcut ağırlıklara göre en optimum değerlere sahiptir."</p></div>
                    <div class="p-4 bg-emerald-50 rounded border-l-4 border-emerald-500"><p class="font-mono text-xs mb-1 text-emerald-600">SONUÇ (SQL Çıktısı):</p><p class="font-bold text-sm text-emerald-800">"Sistem, <span id="logic-city-2">...</span> lokasyonunu 'Yüksek Öncelikli' olarak işaretlemiştir."</p></div>
                </div>

                <div class="border rounded-lg p-5 bg-white shadow-sm flex flex-col justify-between">
                    
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-slate-900 uppercase text-xs flex items-center gap-2"><i class="fa-solid fa-chart-simple text-emerald-500"></i> Ciro & ROI Analizi</h4>
                            <p class="text-[10px] text-slate-400 mt-1">Tahmini yıllık ciro ve yatırım geri dönüş süresi.</p>
                        </div>
                        <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-[10px] font-bold rounded animate-pulse">SİMÜLASYON</span>
                    </div>

                    <div class="flex items-end gap-6 h-32 mb-4 border-b border-dashed border-slate-200 pb-2 px-4">
                        <div class="w-1/2 flex flex-col justify-end items-center h-full">
                            <span class="text-xs font-bold text-slate-600 mb-1">₺33.5M</span>
                            <div class="bg-slate-300 w-full rounded-t-lg relative" style="height: 60%;"></div>
                            <span class="text-[9px] font-bold text-slate-400 uppercase mt-2">Mevcut</span>
                        </div>
                        <div class="w-1/2 flex flex-col justify-end items-center h-full">
                            <span id="proj-revenue" class="text-sm font-black text-emerald-600 mb-1">₺42.0M</span>
                            <div class="bg-emerald-500 w-full rounded-t-lg relative shadow-lg shadow-emerald-200" style="height: 85%;"></div>
                            <span class="text-[9px] font-bold text-emerald-700 uppercase mt-2">Öngörülen</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-50 p-2 rounded border border-slate-200">
                            <p class="text-[9px] font-bold text-slate-400 uppercase">Potansiyel Ciro Artışı</p>
                            <h3 id="proj-delta" class="text-lg font-black text-emerald-600">+₺8.5M</h3>
                        </div>
                        <div class="bg-blue-50 p-2 rounded border border-blue-200">
                            <p class="text-[9px] font-bold text-blue-400 uppercase">ROI (Amortisman)</p>
                            <h3 id="roi-time" class="text-lg font-black text-blue-600">14 Ay</h3>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

<script>
    var container = L.DomUtil.get('map');
    if(container != null){ container._leaflet_id = null; }

    var map = L.map('map').setView([39.1, 35.3], 6.0);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);

    var lastSelectedCity = null; 
    var geojsonLayer;
    let charts = {}; 

    function getColor(d) {
        return d > 80 ? '#08519c' : 
               d > 60 ? '#3182bd' : 
               d > 40 ? '#6baed6' : 
               d > 20 ? '#bdd7e7' : 
                           '#eff3ff';  
    }

    function style(feature) {
        var score = feature.properties.potansiyel_skor || 0; 
        
        return { 
            fillColor: getColor(score), 
            weight: 1, 
            opacity: 1, 
            color: '#888', 
            dashArray: '3', 
            fillOpacity: 0.7 
        };
    }

    function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({ 
            weight: 3, 
            color: '#333', 
            dashArray: '',
            fillOpacity: 1 
        });
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { layer.bringToFront(); }
    }

    function resetHighlight(e) { geojsonLayer.resetStyle(e.target); }

    function zoomToFeature(e) {
        var layer = e.target;
        var props = layer.feature.properties;
        lastSelectedCity = props; 

        const slider = document.getElementById('scenarioSlider');
        if(slider) { 
            slider.value = 0; 
            const valText = document.getElementById('scenarioValue');
            if(valText) valText.innerText = "%0 Değişim";
        }

        map.fitBounds(layer.getBounds());
        updateDashboard(props); 
    }

function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });

        var ilIsmi = feature.properties.name || feature.properties.il_adi || feature.properties.ad || "Bilinmeyen İl";
        var score = feature.properties.potansiyel_skor || 0;
        
        layer.bindTooltip(`<b>${ilIsmi}</b><br>Skor: ${score}`, {permanent: false, direction:"top"});
    }

    function drawSubeMarkers(geojsonData) {
        geojsonData.features.forEach(feature => {
            const props = feature.properties;
            const subeSayisi = props.bizim_sube_sayisi || 0;
            if (subeSayisi > 0) {
                let lat, lng;
                if (props.enlem && props.boylam) { lat = props.enlem; lng = props.boylam; }
                else {
                    const center = L.geoJson(feature).getBounds().getCenter();
                    lat = center.lat; lng = center.lng;
                }
                L.circleMarker([lat, lng], {
                    radius: Math.min(6 + (subeSayisi * 2.5), 25),
                    fillColor: "#ff0000", color: "#ffffff", weight: 2, fillOpacity: 0.9, interactive: false
                }).addTo(map).bindPopup(`<b>${props.il_adi}</b><br>Şube: ${subeSayisi}`);
            }
        });
    }

    function veriyiYukle() {
        fetch('/api/harita-verisi')
            .then(r => r.json())
            .then(data => {
                geojsonLayer = L.geoJson(data, { style: style, onEachFeature: onEachFeature }).addTo(map);
                drawSubeMarkers(data);
            })
            .catch(err => console.error("Hata:", err));
    }

    function initCharts() {
        if(!document.getElementById('radarChart')) return;

        const commonOptions = {
            responsive: true, maintainAspectRatio: false, layout: { padding: 5 },
            plugins: { legend: { display: false } },
            scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 100, ticks: { display: false }, pointLabels: { font: { size: 9 } } } }
        };

        charts.radar = new Chart(document.getElementById('radarChart'), { type: 'radar', data: { labels: ['Nüfus', 'Gelir', 'Eğitim', 'Gençlik', 'Rekabet'], datasets: [{ data: [0,0,0,0,0], backgroundColor: 'rgba(190, 18, 60, 0.2)', borderColor: '#be123c', borderWidth: 2 }] }, options: commonOptions });
        
        const barOptions = JSON.parse(JSON.stringify(commonOptions)); delete barOptions.scales.r;
        barOptions.scales.y = { beginAtZero: true, suggestedMax: 5, ticks: { stepSize: 1, font: { size: 10 } } };
        barOptions.scales.x = { display: true, ticks: { font: { size: 10 } }, grid: {display:false} };
        charts.bar = new Chart(document.getElementById('barChart'), { type: 'bar', data: { labels: ['Mevcut', 'Hedef'], datasets: [{ data: [0,0], backgroundColor: ['#1e293b', '#be123c'], borderRadius: 4 }] }, options: barOptions });
        
        charts.doughnut = new Chart(document.getElementById('doughnutChart'), { type: 'doughnut', data: { labels: ['Pay', 'Diğer'], datasets: [{ data: [0,100], backgroundColor: ['#be123c', '#f1f5f9'], borderWidth: 0 }] }, options: { ...commonOptions, cutout: '70%' } });
        
        charts.polar = new Chart(document.getElementById('polarChart'), { type: 'polarArea', data: { labels: ['Lojistik', 'Kira', 'Talep', 'Risk'], datasets: [{ data: [0,0,0,0], backgroundColor: ['rgba(51, 65, 85, 0.7)', 'rgba(71, 85, 105, 0.7)', 'rgba(190, 18, 60, 0.7)', 'rgba(148, 163, 184, 0.7]'], borderWidth: 1 }] }, options: commonOptions });
    }

    function updateDashboard(props) {
    if (!props) return;

    const slider = document.getElementById('scenarioSlider');
    const degisimOrani = slider ? parseInt(slider.value) : 0; 
    const carpan = 1 + (degisimOrani / 100); 

    const valText = document.getElementById('scenarioValue');
    if(valText) {
        valText.innerText = (degisimOrani > 0 ? "+" : "") + "%" + degisimOrani + " Değişim";
        valText.style.color = degisimOrani > 0 ? "#10b981" : (degisimOrani < 0 ? "#ef4444" : "#2563eb");
    }

    const simNufus = (props.nufus || 0) * carpan;
    const simGelir = (props.ortalama_gelir || 0) * carpan;
    const simOgrenci = (props.ogrenci_sayisi || 0) * carpan;
    
    let rawSkor = props.potansiyel_skor || 0;
    let simSkor = Math.min(100, Math.max(0, rawSkor + (degisimOrani / 2)));

    document.getElementById('selected-city-title').innerText = "Seçili Bölge: " + (props.name || props.il_adi);
    
    const scoreEl = document.getElementById('calculation-score-value');
    if(scoreEl) scoreEl.innerText = Math.round(simSkor);
    
    const statusEl = document.getElementById('calculation-status-text');
    if (statusEl) {
         if (simSkor >= 70) { statusEl.innerText = "STRATEJİK FIRSAT"; statusEl.style.color = "#10b981"; }
         else if (simSkor >= 40) { statusEl.innerText = "GÖZLEM GEREKLİ"; statusEl.style.color = "#f59e0b"; } 
         else { statusEl.innerText = "YATIRIM RİSKLİ"; statusEl.style.color = "#ef4444"; }
    }

    const adviceBox = document.getElementById('kds-advice-box');
    const adviceText = document.getElementById('kds-advice-text');

    if (adviceText && adviceBox) {
        if (simSkor >= 75) {
            adviceText.innerHTML = `✅ <span class="text-green-700">YATIRIM ONAYLANDI:</span> Bölge potansiyeli hedefleri karşılıyor.`;
            adviceBox.className = "mt-4 p-4 rounded-lg border-l-8 border-green-500 bg-green-50 shadow-lg transition-all duration-300";
        } else if (simSkor >= 50) {
            adviceText.innerHTML = `⚠️ <span class="text-yellow-700">DİKKATLİ İLERLE:</span> Potansiyel var ancak ek maliyet analizi şart.`;
            adviceBox.className = "mt-4 p-4 rounded-lg border-l-8 border-yellow-500 bg-yellow-50 shadow-lg transition-all duration-300";
        } else {
            adviceText.innerHTML = `⛔ <span class="text-red-700">REDDEDİLDİ:</span> Mevcut şartlarda yatırım kârlı görünmüyor.`;
            adviceBox.className = "mt-4 p-4 rounded-lg border-l-8 border-red-500 bg-red-50 shadow-lg transition-all duration-300";
        }
    }

    if (charts.radar) {
        charts.radar.data.datasets[0].data = [
            Math.min(100, (simNufus / 50000) * 10), 
            Math.min(100, (simGelir / 200) * 10), 
            Math.min(100, (simOgrenci / 10000) * 20),
            70, 
            (100 - (props.rakip_sube_sayisi || 0) * 10)
        ];
        charts.radar.update();
    }

    if (charts.bar) {
        const hedef = Math.max(1, Math.round(simSkor / 20)); 
        charts.bar.data.datasets[0].data = [props.bizim_sube_sayisi || 0, hedef];
        charts.bar.update();
    }

    if (charts.doughnut) {
        charts.doughnut.data.datasets[0].data = [simSkor, 100 - simSkor];
        charts.doughnut.update();
    }

    if (charts.polar) {
        charts.polar.data.datasets[0].data = [
            Math.min(100, (simNufus / 10000)), 
            Math.min(100, (simGelir / 5)),     
            simSkor,                           
            Math.max(10, 100 - simSkor)        
        ];
        charts.polar.update();
    }
}

    document.addEventListener('input', function(e) {
        if(e.target.id === 'scenarioSlider' && lastSelectedCity) {
            updateDashboard(lastSelectedCity);
        }
    });

    window.addEventListener('load', function() {
        if(typeof map !== 'undefined') setTimeout(() => map.invalidateSize(), 300);
        veriyiYukle(); 
        initCharts();  
    });
</script>
</body>
</html>